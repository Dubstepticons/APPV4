# Alembic Database Migrations

This directory contains Alembic database migrations for APPSIERRA.

## Quick Start

### Create a new migration
```bash
poetry run alembic revision --autogenerate -m "Add users table"
```

### Apply migrations
```bash
poetry run alembic upgrade head
```

### Revert last migration
```bash
poetry run alembic downgrade -1
```

### Show current version
```bash
poetry run alembic current
```

### Show migration history
```bash
poetry run alembic history --verbose
```

## Configuration

### Database URL

Set the database connection via environment variable:

```bash
export DATABASE_URL="postgresql://user:password@localhost:5432/appsierra"
```

Or update `alembic.ini` directly:

```ini
sqlalchemy.url = postgresql://user:password@localhost:5432/appsierra
```

### Import Your Models

Update `alembic/env.py` to import your SQLAlchemy models:

```python
# Import your Base and models
from config.database import Base
from services.trade_models import Trade, Position, Account

# Set target_metadata
target_metadata = Base.metadata
```

## Directory Structure

```
alembic/
├── env.py              # Migration environment configuration
├── script.py.mako      # Migration template
├── versions/           # Generated migration scripts
│   └── (migrations will appear here)
└── README              # This file
```

## Best Practices

1. **Always review autogenerated migrations** - Alembic might miss some changes
2. **Test migrations** - Run upgrade and downgrade in dev environment first
3. **Use descriptive messages** - Makes history easier to understand
4. **Avoid manual edits** - Use Alembic commands to modify migrations
5. **Version control** - Commit migrations to git

## Common Issues

### "Target database is not up to date"
Run `alembic upgrade head` to apply pending migrations.

### "Can't locate revision"
Ensure all migration files are present in `versions/` directory.

### Connection refused
Check DATABASE_URL and ensure PostgreSQL is running.

## Documentation

Full Alembic documentation: https://alembic.sqlalchemy.org/
