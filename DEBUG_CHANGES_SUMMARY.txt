================================================================================
COMPREHENSIVE PNL DEBUG INSTRUMENTATION - CHANGES SUMMARY
================================================================================

This document describes all the debug logging added to trace PnL calculations.

================================================================================
FILE 1: services/trade_service.py
================================================================================

Function: record_closed_trade() [Line 108]

Added debug output at these checkpoints:

[DEBUG ENTRY] - Line 142-148
  â”œâ”€ symbol
  â”œâ”€ realized_pnl (input parameter)
  â”œâ”€ exit_price (input parameter)
  â””â”€ pos_info (position details)

[DEBUG] Imports - Line 153-157
  â””â”€ Verifies get_session and TradeRecord imported

[DEBUG STEP 1] - Line 167-170
  â”œâ”€ entry_price extraction
  â”œâ”€ qty extraction
  â”œâ”€ entry_time extraction
  â””â”€ account extraction

[DEBUG STEP 2A] - Line 175-178 (PnL calculated)
  â”œâ”€ Formula shown: (exit_price - entry_price) * qty
  â”œâ”€ Values plugged in
  â””â”€ Result (realized_pnl)

[DEBUG STEP 2B] - Line 180-182 (PnL NOT calculated)
  â”œâ”€ Flags why calculation was skipped
  â”œâ”€ realized_pnl provided check
  â””â”€ exit_price provided check

[DEBUG STEP 3] - Line 191
  â””â”€ mode={mode} (SIM or LIVE detected)

[DEBUG STEP 4] - Line 194-197 (Balance update check)
  â”œâ”€ state_manager exists: {bool}
  â”œâ”€ realized_pnl is not None: {bool}
  â””â”€ realized_pnl value: {float}

[TRADE CLOSED] - Line 205-214 (Trade summary)
  â”œâ”€ Emoji indicator: ğŸ“ˆ (profit), ğŸ“‰ (loss), â¡ï¸ (breakeven)
  â”œâ”€ Symbol and mode
  â”œâ”€ Entry/Exit prices
  â”œâ”€ Quantity
  â”œâ”€ Calculation formula with actual numbers
  â”œâ”€ P&L with sign
  â”œâ”€ Balance before and after
  â””â”€ Decorative separator bars

[DEBUG STEP 5] - Line 226-236 (TradeRecord creation)
  â”œâ”€ symbol
  â”œâ”€ qty
  â”œâ”€ mode
  â”œâ”€ entry_price
  â”œâ”€ entry_time
  â”œâ”€ exit_price
  â”œâ”€ exit_time
  â”œâ”€ realized_pnl (with conversion check)
  â”œâ”€ is_closed
  â””â”€ account

[DEBUG STEP 6-8] - Line 260-271 (Database operations)
  â”œâ”€ STEP 6: TradeRecord creation
  â”œâ”€ STEP 7: Session add and commit
  â”œâ”€ STEP 8: Verification of saved data
  â”‚   â”œâ”€ Trade ID
  â”‚   â”œâ”€ Symbol
  â”‚   â”œâ”€ Realized PnL in DB (CRITICAL: must match calculated)
  â”‚   â”œâ”€ Mode in DB
  â”‚   â””â”€ Is Closed flag
  â””â”€ log.info() call

[DEBUG STEP 9] - Line 277-287 (Trade summary)
  â”œâ”€ Success message
  â”œâ”€ Trade ID
  â”œâ”€ Mode
  â”œâ”€ Entry/Exit prices
  â”œâ”€ Quantity
  â”œâ”€ Realized P&L
  â”œâ”€ New balance
  â””â”€ Decorative separator bars

[DEBUG ERROR] - Line 291-299 (Exception handling)
  â”œâ”€ Exception message
  â”œâ”€ Exception type
  â”œâ”€ Full traceback
  â””â”€ Logged to app.log

FIXED BUG: Line 187
  Before: log.info(f"balance.updated.{mode}", balance=new_balance, pnl=realized_pnl)
  After:  log.info(f"balance.updated.{mode}: {new_balance:,.2f} (pnl={realized_pnl:+,.2f})")
  Reason: Logger doesn't support keyword arguments

================================================================================
FILE 2: services/stats_service.py
================================================================================

Function: compute_trading_stats_for_timeframe() [Line 46]

Added debug output at these checkpoints:

[DEBUG STATS] Function entry - Line 56-57
  â”œâ”€ timeframe={tf}
  â””â”€ mode={mode}

[DEBUG STATS] Imports - Line 66-68
  â””â”€ Verifies successful import of database and calculation modules

[DEBUG STATS] Query start - Line 72
  â””â”€ Timeframe range (start date)

[DEBUG STATS] Mode detection - Line 81-84
  â”œâ”€ Mode detected from state manager
  â””â”€ Fallback message if detection fails

[DEBUG STATS] Final mode filter - Line 86
  â””â”€ mode={mode} (Final value to be used in query)

[DEBUG STATS] Database session - Line 95
  â””â”€ Opening session for query

[DEBUG STATS] Query results - Line 109
  â”œâ”€ Number of trades found
  â”œâ”€ Timeframe
  â””â”€ Mode

[DEBUG STATS] No trades warning - Line 111-112
  â””â”€ Alerts if no trades found (returns empty stats)

[DEBUG STATS] Per-trade detail - Line 115-118
  â”œâ”€ Trade index
  â”œâ”€ Symbol
  â”œâ”€ PnL value from database
  â”œâ”€ Exit time
  â””â”€ "Added to PnL list" flag

[DEBUG STATS] Query complete - Line 131-133
  â”œâ”€ Total PnL values collected
  â””â”€ PnL list (array of all PnL values from trades)

[DEBUG STATS] Calculation summary - Line 189-197
  â”œâ”€ Total PnL (sum)
  â”œâ”€ Wins count and sum
  â”œâ”€ Losses count and sum
  â”œâ”€ Hit rate (win %)
  â”œâ”€ Max drawdown
  â”œâ”€ Max run-up
  â”œâ”€ Expectancy
  â””â”€ Profit factor

[DEBUG STATS] Return complete - Line 222-225
  â”œâ”€ Number of metrics in result dict
  â”œâ”€ Total PnL (formatted string version)
  â”œâ”€ Trade count
  â””â”€ Decorative separator bars

================================================================================
FILE 3: panels/panel3.py
================================================================================

Function: _load_metrics_for_timeframe() [Line 283]

NOTE: Panel 3 ALREADY HAD comprehensive debug logging in place!

Existing debug checkpoints (Line 288-339):

[DEBUG panel3._load_metrics_for_timeframe]
  â”œâ”€ STEP 1: Called with tf={timeframe}
  â”œâ”€ STEP 2: stats_service import status
  â”œâ”€ STEP 3: State manager obtained
  â”œâ”€ STEP 4: Mode detected
  â”œâ”€ STEP 5: compute_trading_stats_for_timeframe() called
  â”œâ”€ STEP 6: Payload received with metric keys listed
  â”œâ”€ STEP 7: Trade count for mode/timeframe
  â”œâ”€ STEP 8A: Trades found, calling update_metrics
  â”œâ”€ STEP 8B: No trades found, empty state shown
  â”œâ”€ STEP 9: update_metrics completed
  â”œâ”€ STEP 10: Sharpe ratio value
  â”œâ”€ STEP 11: Sharpe bar updated
  â”œâ”€ STEP 12: Total PnL value
  â””â”€ ERROR: Exception handling with message

================================================================================
ADDITIONAL FILES MODIFIED
================================================================================

1. core/sim_balance.py - Line 23
   FIXED: Relative path issue
   Before: SIM_BALANCE_FILE: Path = Path("data/sim_balance.json")
   After:  SIM_BALANCE_FILE: Path = Path(__file__).parent.parent / "data" / "sim_balance.json"
   Reason: Relative path breaks depending on working directory

2. DEBUG_PNL_GUIDE.md - NEW FILE
   Comprehensive guide with:
   â”œâ”€ Overview of debug flow
   â”œâ”€ Detailed checkpoint explanations
   â”œâ”€ Common issues & solutions
   â”œâ”€ How to enable full debug output
   â”œâ”€ Example of full trace
   â””â”€ Troubleshooting workflow

3. QUICK_PNL_DEBUG.txt - NEW FILE
   Quick reference guide with:
   â”œâ”€ 6 main checkpoint summaries
   â”œâ”€ Common issues (3 examples)
   â”œâ”€ Debug settings
   â”œâ”€ Expected console output
   â””â”€ Key files to check

================================================================================
DEBUG OUTPUT FLOW DIAGRAM
================================================================================

Position closes (qty â†’ 0)
         â†“
record_closed_trade() [trade_service.py]
  â”œâ”€ [DEBUG ENTRY]
  â”œâ”€ [DEBUG STEP 1-2] Calculate or verify PnL
  â”œâ”€ [DEBUG STEP 3] Detect mode
  â”œâ”€ [DEBUG STEP 4] Update balance
  â”œâ”€ [TRADE CLOSED] Summary
  â”œâ”€ [DEBUG STEP 5-9] Save to database
  â””â”€ [DEBUG ERROR] If exception
         â†“
compute_trading_stats_for_timeframe() [stats_service.py]
  â”œâ”€ [DEBUG STATS] Entry
  â”œâ”€ [DEBUG STATS] Query database
  â”œâ”€ [DEBUG STATS] Per-trade detail
  â”œâ”€ [DEBUG STATS] Query results
  â””â”€ [DEBUG STATS] Calculation summary
         â†“
_load_metrics_for_timeframe() [panel3.py]
  â”œâ”€ [DEBUG panel3._load_metrics_for_timeframe] STEP 1-7
  â”œâ”€ [DEBUG panel3._load_metrics_for_timeframe] STEP 8-12
  â””â”€ update_metrics()
         â†“
Panel 3 UI displays metrics
  â”œâ”€ Total PnL
  â”œâ”€ Max Drawdown/Run-Up
  â”œâ”€ Hit Rate
  â”œâ”€ Trade count
  â””â”€ Other stats

================================================================================
HOW TO USE THESE DEBUG OUTPUTS
================================================================================

1. CLOSE A TRADE in the app
2. LOOK AT CONSOLE OUTPUT for the debug messages above
3. FOLLOW THE FLOW from [DEBUG ENTRY] to final display
4. CHECK EACH CHECKPOINT for âœ“ (working) or âœ— (issue)

Example:
  âœ“ [DEBUG STEP 2A] PnL calculated = Good
  âœ— [DEBUG STEP 2B] PnL NOT calculated = Stop, check exit_price
  âœ“ [DEBUG STEP 8] Trade committed = Good
  âœ— [DEBUG STATS] Found 0 trades = Stop, check mode filter

================================================================================
TESTING CHECKLIST
================================================================================

Close a trade and verify:

[ ] [DEBUG ENTRY] appears with correct symbol
[ ] [DEBUG STEP 2A] shows PnL calculation (or Step 2B with explanation)
[ ] [DEBUG STEP 3] shows mode (SIM or LIVE)
[ ] [DEBUG STEP 4] shows balance update with values
[ ] [TRADE CLOSED] shows entry, exit, qty, P&L, new balance
[ ] [DEBUG STEP 8] âœ“ Trade committed to database with ID
[ ] [DEBUG STATS] Found trades in database
[ ] [DEBUG STATS] PnL list shows the values
[ ] [DEBUG STATS] Total PnL is the sum of PnL list
[ ] [DEBUG panel3._load_metrics_for_timeframe] STEP 9: update_metrics completed
[ ] Panel 3 displays Total PnL matching the calculated value

If any are missing or show âœ—, check that checkpoint in the debug output!

================================================================================
PERFORMANCE NOTES
================================================================================

All debug output uses print() statements (not logging to file).
This means:
  âœ“ Console shows real-time output
  âœ“ No file I/O overhead
  âœ“ Can be easily disabled by removing print() calls later
  âœ“ Output goes to stdout/stderr in real-time

To remove debug output later (after testing):
  1. Search for "print(f\"[DEBUG" in each file
  2. Delete or comment out those lines
  3. Keep the actual logic code intact

================================================================================
